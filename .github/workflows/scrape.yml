name: TMS Trade Book Scraper

on:
  # Run daily at 9:30 AM UTC (3:15 PM Nepal time - after market closes at 3:05 PM)
  # Nepal stock market operates Sunday-Thursday
  schedule:
    - cron: '30 9 * * 0-4'  # Sun-Thu at 3:15 PM Nepal
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Trade Book Scraper
        env:
          TMS_USERNAME: ${{ secrets.TMS_USERNAME }}
          TMS_PASSWORD: ${{ secrets.TMS_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SUPABASE_ENDPOINT: ${{ secrets.SUPABASE_ENDPOINT }}
          SUPABASE_REGION: ${{ secrets.SUPABASE_REGION }}
          SUPABASE_ACCESS_KEY: ${{ secrets.SUPABASE_ACCESS_KEY }}
          SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_SECRET_KEY }}
          SUPABASE_BUCKET_NAME: ${{ secrets.SUPABASE_BUCKET_NAME }}
          HEADLESS: "true"
        run: |
          python trade_book.py
      
      - name: Upload CSV artifact (backup)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trade-book-history
          path: trade-book-history-*.csv
          retention-days: 7
